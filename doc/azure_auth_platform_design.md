# Azure 認証・認可基盤層 設計書（シンプル・低コスト版）

## 1. 全体アーキテクチャ

### 基本方針
- **データ基盤層との統合**: 既存のAzure AD B2Cを拡張・活用
- **1000人規模最適化**: 過度な複雑性を避け、実用性重視
- **段階的構築**: 基本認証から高度な認可制御まで段階的実装
- **コスト効率**: 月額コスト 5-15万円程度を目標

## 2. 推奨Azureサービス構成

### 2.1 統合認証システム（既存拡張）

#### **Azure Active Directory B2C（拡張）**
- **用途**: 住民・職員・外部ユーザーの統合認証
- **料金**: 月額 約8,000円（1,200ユーザー、MFA込み）
- **選定理由**: データ基盤で既に導入済み、住民向けに最適化

#### **Azure Active Directory（追加）**
- **用途**: 市政職員・管理者向け高度認証
- **料金**: 月額 約12,000円（Premium P1、100ユーザー）
- **選定理由**: 企業向け機能、条件付きアクセス対応

### 2.2 権限管理システム

#### **Azure RBAC（Role-Based Access Control）**
- **用途**: Azureリソースへのアクセス制御
- **料金**: 標準機能（追加コストなし）
- **選定理由**: Azure サービス統合、きめ細かい権限設定

#### **Azure AD Privileged Identity Management（PIM）**
- **用途**: 特権アカウントの管理・監視
- **料金**: Premium P2に含まれる（月額+5,000円）
- **選定理由**: セキュリティ強化、一時的権限昇格

### 2.3 API・アプリケーション認証

#### **Azure API Management（Developer）**
- **用途**: APIアクセス制御・認証
- **料金**: 月額 約6,000円
- **選定理由**: 各システム間API連携の統一認証

#### **Azure App Service認証**
- **用途**: Webアプリケーションの認証
- **料金**: 標準機能（追加コストなし）
- **選定理由**: 簡単設定、各種IDプロバイダー対応

### 2.4 多要素認証・セキュリティ

#### **Azure AD Multi-Factor Authentication**
- **用途**: 全ユーザーの多要素認証
- **料金**: B2C/AD Premium に含まれる
- **選定理由**: 高セキュリティ、多様な認証方法

#### **Azure AD Identity Protection**
- **用途**: リスクベース認証・脅威検知
- **料金**: Premium P2 に含まれる
- **選定理由**: AI活用の自動脅威検知

### 2.5 監査・ログ管理（データ基盤と統合）

#### **Azure AD Audit Logs（既存活用）**
- **用途**: 認証・認可ログの記録
- **料金**: Log Analytics に統合済み
- **選定理由**: データ基盤のLog Analyticsと統合

## 3. ユーザー分類・権限設計

### 3.1 ユーザーカテゴリ
```yaml
住民（800人）:
  認証方式: Azure AD B2C
  認証強度: 基本（パスワード + SMS）
  アクセス範囲: 住民サービス、個人情報、コミュニティ
  セッション: 7日間

市政職員（50人）:
  認証方式: Azure AD
  認証強度: 強化（パスワード + Authenticator）
  アクセス範囲: 業務システム、住民情報（職務範囲）
  セッション: 8時間

事業者・パートナー（100人）:
  認証方式: Azure AD B2C（外部アカウント）
  認証強度: 基本（パスワード + Email確認）
  アクセス範囲: 事業関連データのみ
  セッション: 24時間

管理者・特権ユーザー（10人）:
  認証方式: Azure AD + PIM
  認証強度: 最強（パスワード + Authenticator + 生体認証）
  アクセス範囲: 全システム（承認制）
  セッション: 4時間

一時ユーザー・ゲスト（200人/年）:
  認証方式: Azure AD B2C（招待制）
  認証強度: 基本（パスワード + Email確認）
  アクセス範囲: 限定的（期間指定）
  セッション: 当日のみ
```

### 3.2 役割ベース権限（RBAC）設計
```yaml
■ 住民レベル
住民（一般）:
  - 個人ダッシュボード: 読み取り
  - 個人データ: 読み取り・更新（本人のみ）
  - 公共サービス予約: 作成・キャンセル
  - コミュニティ参加: 投稿・コメント

住民代表:
  - 住民（一般）権限 + 
  - 住民アンケート: 作成・集計
  - 住民意見: 取りまとめ・提出

■ 職員レベル
窓口職員:
  - 住民情報: 読み取り（職務範囲）
  - 各種申請: 受付・処理
  - 証明書発行: 作成・印刷

係長・主任:
  - 窓口職員権限 + 
  - 部門データ: 読み取り・分析
  - 承認業務: 決裁・差し戻し
  - 部下の業務: 監督・指導

課長:
  - 係長権限 + 
  - 部門システム: 設定変更
  - 予算データ: 読み取り・計画
  - 人事評価: 入力・承認

部長:
  - 課長権限 + 
  - 複数部門データ: 横断的読み取り
  - 政策立案: 資料作成・提案
  - 重要決裁: 承認・決定

副市長・市長:
  - 全データ: 読み取り（要承認）
  - 重要設定: 変更承認
  - 緊急時権限: 一時的全権限

■ 事業者レベル
農業従事者:
  - 農業データ: 読み取り・入力
  - 気象情報: 読み取り
  - 出荷管理: 作成・更新

製造業従事者:
  - 製造データ: 読み取り・入力
  - 在庫管理: 更新
  - 品質管理: 記録・報告

IT関係者:
  - システム監視: 読み取り
  - 技術データ: 読み取り・分析
  - 開発環境: 限定的操作

商業従事者:
  - 売上データ: 入力・集計
  - 在庫情報: 更新
  - 顧客管理: 作成・更新

■ 管理者レベル
システム管理者:
  - 全システム: 設定・運用
  - ユーザー管理: 作成・削除・権限変更
  - セキュリティ: 監視・対応

データ管理者:
  - 全データ: 読み取り・分析（個人情報マスク）
  - バックアップ: 実行・確認
  - データ品質: 監視・改善

セキュリティ管理者:
  - セキュリティログ: 全権限
  - 脅威対応: 緊急措置・復旧
  - 監査対応: 証跡提供・報告
```

## 4. セキュリティポリシー設計

### 4.1 条件付きアクセス
```yaml
基本ポリシー:
  場所ベース:
    - 市内アクセス: 通常認証
    - 市外アクセス: MFA必須
    - 海外アクセス: ブロック（管理者除く）
  
  デバイスベース:
    - 管理対象デバイス: 通常アクセス
    - 個人デバイス: 制限付きアクセス
    - 未登録デバイス: 読み取りのみ
  
  時間ベース:
    - 業務時間: 通常アクセス
    - 夜間・休日: MFA必須
    - 緊急時: 緊急承認プロセス

高リスクアクセス:
  管理者権限:
    - 必須: MFA + 承認者確認
    - 時間制限: 4時間で自動失効
    - 監視: リアルタイム活動監視
  
  個人情報アクセス:
    - 必須: 業務正当性確認
    - ログ: 詳細アクセスログ記録
    - 制限: 目的外利用の禁止
  
  システム設定変更:
    - 必須: 変更管理プロセス
    - 承認: 上位者承認 + 記録
    - 確認: 変更前後の差分記録
```

### 4.2 パスワードポリシー
```yaml
住民向け:
  最小長: 8文字
  複雑性: 英数字混在推奨
  有効期限: なし（侵害時のみ変更要求）
  再利用: 過去3回分禁止

職員向け:
  最小長: 12文字
  複雑性: 英数字記号必須
  有効期限: 90日
  再利用: 過去12回分禁止

管理者向け:
  最小長: 16文字
  複雑性: 英数字記号必須 + 辞書攻撃対策
  有効期限: 60日
  再利用: 過去24回分禁止
  追加: パスフレーズ推奨
```

## 5. 段階的実装計画

### Phase 1: 基本認証統合（0-2ヶ月）
```yaml
実装サービス:
  - Azure AD B2C 拡張設定
  - Azure AD 新規導入
  - 基本RBAC設定
  - MFA有効化

月額コスト: 約3万円（追加分）

実装内容:
  - 住民・職員の統合認証環境
  - 基本的な権限分離
  - 簡単なMFA設定
  - 主要システムのSSO統合
```

### Phase 2: 高度認可制御（3-4ヶ月目）
```yaml
追加サービス:
  - API Management
  - Azure AD Premium P2
  - 条件付きアクセス

月額コスト: 約8万円（累計）

実装内容:
  - 詳細な権限制御
  - 条件付きアクセスポリシー
  - APIレベルでの認証・認可
  - リスクベース認証
```

### Phase 3: 完全監視・ガバナンス（5-6ヶ月目）
```yaml
追加サービス:
  - Azure AD PIM
  - Identity Protection
  - 高度監査機能

月額コスト: 約12万円（累計）

実装内容:
  - 特権アカウント管理
  - 自動脅威検知・対応
  - 包括的な監査証跡
  - コンプライアンス対応
```

## 6. システム連携設計

### 6.1 既存データ基盤との統合
```yaml
認証連携:
  Power BI: Azure AD SSO
  SQL Database: Azure AD認証
  Data Factory: マネージドID
  Purview: Azure AD統合

ログ統合:
  認証ログ → Log Analytics
  認可ログ → Log Analytics  
  監査ログ → Data Lake Storage
  アラート → Azure Monitor
```

### 6.2 外部システム連携
```yaml
SAML連携:
  - 既存基幹システム
  - 外部クラウドサービス
  - パートナー企業システム

OAuth/OpenID Connect:
  - モバイルアプリ
  - IoTデバイス認証
  - API呼び出し認証

レガシーシステム:
  - AD Connect（オンプレミス）
  - LDAP認証プロキシ
  - Kerberos統合
```

## 7. セキュリティ運用

### 7.1 日常監視項目
```yaml
認証監視:
  - 失敗ログイン回数
  - 異常な時間・場所からのアクセス
  - パスワードスプレー攻撃
  - 権限昇格の異常パターン

リスクシグナル:
  - 複数デバイスからの同時ログイン
  - 地理的に不可能な移動
  - 通常と異なるアクセスパターン
  - 大量データダウンロード

自動対応:
  - 高リスクユーザーの一時停止
  - MFA要求の強制
  - 管理者への即座通知
  - インシデント記録の自動作成
```

### 7.2 定期メンテナンス
```yaml
アカウント管理:
  - 週次: 無効アカウントの清理
  - 月次: 権限の棚卸し・見直し
  - 四半期: アクセスレビュー実施
  - 年次: セキュリティポリシー見直し

パフォーマンス監視:
  - 認証応答時間の監視
  - SSO成功率の追跡
  - システム可用性の確認
  - ユーザー満足度調査
```

## 8. コスト詳細

### 8.1 月額運用コスト（Phase 3完成時）
```yaml
認証サービス:
  - Azure AD B2C: 8,000円（1,200ユーザー）
  - Azure AD Premium P2: 17,000円（100ユーザー）

認可・管理:
  - API Management: 6,000円
  - PIM・Identity Protection: P2に含まれる

監視・ログ:
  - Log Analytics: データ基盤と共有
  - Azure Monitor: データ基盤と共有

月額合計: 約31,000円
年間コスト: 約37万円
```

### 8.2 初期構築費用
```yaml
設計・開発: 150万円
  - 認証設計・構築: 80万円
  - 権限設計・設定: 40万円
  - 既存システム統合: 30万円

研修・移行: 50万円
  - 管理者研修: 30万円
  - ユーザー移行支援: 20万円

初期費用合計: 200万円
```

## 9. ユーザー体験設計

### 9.1 住民向けUX
```yaml
初回登録:
  1. 市役所での本人確認・登録
  2. QRコードでのアカウント作成案内
  3. スマートフォンでの簡単設定
  4. SMS認証での本人確認完了

日常利用:
  - ワンクリックログイン（7日間記憶）
  - 顔認証・指紋認証対応
  - パスワード忘れ時の簡単リセット
  - 多言語対応（日本語・英語・中国語）
```

### 9.2 職員向けUX
```yaml
業務開始:
  1. PCログイン時の自動SSO
  2. Authenticatorアプリでの承認
  3. 業務システムへのシームレスアクセス
  4. 権限に応じた画面・機能表示

権限変更:
  - セルフサービスでの一時権限要求
  - 上司による迅速な承認プロセス
  - 権限変更の自動通知
  - 監査証跡の自動記録
```

## 10. コンプライアンス対応

### 10.1 法的要件
```yaml
個人情報保護法:
  - 目的外利用の防止
  - アクセス権限の最小化
  - 利用履歴の記録・保管
  - 本人開示請求への対応

マイナンバー法:
  - 特定個人情報の厳格管理
  - アクセス制御・監視強化
  - 委託先も含めた安全管理
  - 廃棄・削除の確実な実行
```

### 10.2 監査対応
```yaml
内部監査:
  - 四半期ごとのアクセスレビュー
  - 権限付与の妥当性確認
  - システム設定の適正性確認
  - インシデント対応の検証

外部監査:
  - 年次セキュリティ監査対応
  - 証跡の提供・説明
  - 改善計画の策定・実行
  - 認定取得（ISO27001等）
```

## 11. 次フェーズ拡張計画

### Phase 4: AI・機械学習活用（2年目）
```yaml
追加機能:
  - 行動分析による異常検知
  - リスクスコアの自動算出
  - 適応的認証（コンテキスト認識）
  - 自動権限調整

追加コスト: 月額10,000円
```

### Phase 5: ゼロトラスト完全実装（3年目）
```yaml
追加機能:
  - デバイス信頼評価
  - ネットワークマイクロセグメンテーション
  - 継続的検証・認証
  - 完全な属性ベースアクセス制御

追加コスト: 月額15,000円
```

この設計により、既存のデータ基盤と統合された、1000人規模の都市に最適化されたセキュアで使いやすい認証・認可基盤を構築できます。