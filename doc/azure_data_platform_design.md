# Azure データ基盤層 設計書（シンプル・低コスト版）

## 1. 全体アーキテクチャ

### 基本方針
- **1000人規模に最適化**: 過度なスケーラビリティより実用性重視
- **段階的構築**: 必要最小限から開始し、成長に応じて拡張
- **コスト効率**: 月額コスト 10-20万円程度を目標
- **運用簡素化**: マネージドサービス中心で保守負荷軽減

## 2. 推奨Azureサービス構成

### 2.1 データレイク・ストレージ層

#### **Azure Data Lake Storage Gen2** 
- **用途**: 全データの中央保管庫
- **料金**: 月額 約15,000円（1TB、LRS）
- **選定理由**: 階層ストレージでコスト最適化、分析ツールとの親和性

#### **Azure Blob Storage**
- **用途**: ログファイル、バックアップ、アーカイブ
- **料金**: 月額 約3,000円（100GB、クール層）
- **選定理由**: 低頻度アクセスデータの超低コスト保管

### 2.2 リアルタイムデータ処理

#### **Azure Event Hubs Basic**
- **用途**: IoTセンサー、システムログのストリーミング取り込み
- **料金**: 月額 約1,500円（1 スループットユニット）
- **選定理由**: 1000人規模のIoTデータには十分、シンプル設定

#### **Azure Stream Analytics**
- **用途**: リアルタイムデータの変換・集計・異常検知
- **料金**: 月額 約12,000円（1 ストリーミングユニット）
- **選定理由**: SQLライクな処理、運用が簡単

### 2.3 データウェアハウス

#### **Azure SQL Database（Basic/Standard）**
- **用途**: マスターデータ、トランザクションデータ
- **料金**: 月額 約8,000円（S2: 50DTU）
- **選定理由**: 小規模にはSynapse不要、既存SQLスキル活用可

#### **Azure Synapse Analytics（オンデマンド）**
- **用途**: 大量データ分析（月1-2回の重い処理のみ）
- **料金**: 月額 約3,000円（使用時のみ課金）
- **選定理由**: 必要時のみ使用、コスト効率的

### 2.4 データ統合・パイプライン

#### **Azure Data Factory**
- **用途**: データの取り込み、変換、移動の自動化
- **料金**: 月額 約5,000円（小規模パイプライン想定）
- **選定理由**: GUIベース設計、多様なデータソース対応

### 2.5 メタデータ・カタログ

#### **Azure Purview（スターター）**
- **用途**: データカタログ、リネージ管理、ガバナンス
- **料金**: 月額 約10,000円
- **選定理由**: データ探索性向上、コンプライアンス対応

### 2.6 分析・可視化

#### **Power BI Pro**
- **用途**: ダッシュボード、レポート作成
- **料金**: 月額 約1,000円/ユーザー × 20ユーザー = 20,000円
- **選定理由**: 直感的操作、Azureとの親和性

## 3. 段階的実装計画

### Phase 1: 基盤構築（最初の3ヶ月）
```yaml
実装サービス:
  - Azure Data Lake Storage Gen2
  - Azure SQL Database
  - Azure Data Factory
  - Power BI Pro

月額コスト: 約4.8万円

実装内容:
  - 基本的なデータ保管庫設置
  - 住民基本情報のマスターデータ管理
  - 簡単なETLパイプライン構築
  - 基本ダッシュボード作成
```

### Phase 2: リアルタイム処理追加（4-6ヶ月目）
```yaml
追加サービス:
  - Azure Event Hubs
  - Azure Stream Analytics

月額コスト: 約6.1万円（累計）

実装内容:
  - IoTセンサーデータのリアルタイム取り込み
  - エネルギー使用量の即時監視
  - 異常値自動検知・アラート
```

### Phase 3: 高度分析機能（7-12ヶ月目）
```yaml
追加サービス:
  - Azure Purview
  - Azure Synapse Analytics（オンデマンド）

月額コスト: 約7.4万円（累計）

実装内容:
  - データガバナンス強化
  - 大規模データ分析の定期実行
  - 予測分析・機械学習準備
```

## 4. 具体的な実装例

### 4.1 IoTデータフロー
```
IoTセンサー → Event Hubs → Stream Analytics → Data Lake + SQL DB → Power BI
     ↓
   (例: エネルギーセンサー)
   - マイクロ炉出力: 500kW
   - 各世帯消費量: 1.2kW平均
   - 農業施設: 80kW
   - 製造施設: 150kW
```

### 4.2 住民データ管理
```
住民情報システム → Data Factory → SQL Database
     ↓
   (マスターデータ)
   - 住民基本情報: 1,000人
   - 世帯情報: 350世帯
   - 職業・スキル情報
   - 健康・教育データ
```

### 4.3 施設・設備データ
```
各施設システム → Event Hubs → Data Lake Storage
     ↓
   (設備管理データ)
   - 建物: 500棟
   - インフラ設備: 1,000箇所
   - 農業設備: 200箇所
   - 製造設備: 100箇所
```

## 5. コスト最適化戦略

### 5.1 ストレージコスト削減
```yaml
データライフサイクル管理:
  - ホット層（30日）: 日次アクセスデータ
  - クール層（1年）: 週次・月次レポート用
  - アーカイブ層（7年）: 長期保存・監査用

自動化ルール:
  - 30日後: ホット → クール移行
  - 1年後: クール → アーカイブ移行
  - 不要データの自動削除
```

### 5.2 コンピューティングコスト削減
```yaml
使用パターン最適化:
  - Stream Analytics: 平日8-20時のみ稼働
  - Synapse Analytics: 月次レポート時のみ起動
  - SQL Database: 夜間はスケールダウン

リザーブドインスタンス:
  - 1年契約で30%コスト削減
  - 安定利用サービスに適用
```

### 5.3 運用コスト削減
```yaml
自動化による工数削減:
  - Data Factory: 週次バッチ処理の自動実行
  - Azure Automation: 定期的なクリーンアップ
  - Azure Monitor: 異常時の自動アラート

セルフサービス分析:
  - Power BI: 住民課スタッフが自力でレポート作成
  - Azure Purview: データ探索の民主化
```

## 6. セキュリティ・ガバナンス

### 6.1 低コストセキュリティ対策
```yaml
Azure Active Directory B2C:
  - 住民認証: 月額約5,000円（1,000ユーザー）
  - 多要素認証: 標準機能で追加コストなし

Azure Key Vault:
  - 暗号化キー管理: 月額約1,000円
  - 接続文字列の安全な管理

SQL Database:
  - Transparent Data Encryption: 追加コストなし
  - Always Encrypted: 機密データ保護
```

### 6.2 データガバナンス
```yaml
Azure Purview活用:
  - データ分類の自動化
  - 個人情報の自動マスキング
  - データリネージの可視化

コンプライアンス:
  - GDPR対応: データ保持期間の自動管理
  - 個人情報保護法対応: アクセスログの取得
```

## 7. 監視・運用

### 7.1 Azure Monitor + Log Analytics
```yaml
月額コスト: 約3,000円
監視項目:
  - リソース使用率
  - パフォーマンスメトリクス
  - エラーログ・例外
  - セキュリティイベント

アラート設定:
  - ストレージ使用量 80%超過
  - SQL DB パフォーマンス低下
  - Stream Analytics エラー発生
```

### 7.2 自動スケーリング
```yaml
Azure SQL Database:
  - 平日: Standard S2（50 DTU）
  - 夜間・休日: Basic（5 DTU）
  - 月次処理時: Standard S4（200 DTU）

Event Hubs:
  - 通常: 1 スループットユニット
  - イベント時: 2 スループットユニット（自動スケール）
```

## 8. 総コスト見積り

### 8.1 月額運用コスト（Phase 3完成時）
```yaml
ストレージ:
  - Data Lake Storage Gen2: 15,000円
  - Blob Storage: 3,000円

コンピューティング:
  - SQL Database: 8,000円
  - Stream Analytics: 12,000円
  - Event Hubs: 1,500円
  - Synapse Analytics: 3,000円

分析・管理:
  - Power BI Pro: 20,000円
  - Azure Purview: 10,000円
  - Data Factory: 5,000円

セキュリティ・監視:
  - Azure AD B2C: 5,000円
  - Key Vault: 1,000円
  - Monitor + Log Analytics: 3,000円

月額合計: 約86,500円
年間コスト: 約104万円
```

### 8.2 初期構築費用
```yaml
設計・開発: 200万円
  - アーキテクチャ設計: 50万円
  - データパイプライン開発: 100万円
  - ダッシュボード作成: 30万円
  - テスト・移行: 20万円

研修・導入支援: 50万円
  - 管理者研修: 30万円
  - ユーザー研修: 20万円

初期費用合計: 250万円
```

## 9. 次フェーズ拡張計画

### Phase 4: AI・機械学習統合（2年目）
```yaml
追加サービス:
  - Azure Machine Learning: 月額15,000円
  - Cognitive Services: 月額10,000円

実装内容:
  - 住民行動予測モデル
  - エネルギー需要予測
  - 異常検知の高度化
  - 音声・画像解析
```

### Phase 5: 高度分析・予測（3年目）
```yaml
追加サービス:
  - Azure Digital Twins: 月額20,000円
  - Time Series Insights: 月額8,000円

実装内容:
  - 都市全体のデジタルツイン
  - 時系列データの高度分析
  - シミュレーション・最適化
```

この設計により、小規模スタートから段階的に成長でき、1000人規模の都市に最適化されたコスト効率的なデータ基盤を構築できます。